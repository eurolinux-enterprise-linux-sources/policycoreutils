From 242d7c9cf7003bb45a153592da8adcee74cb28c6 Mon Sep 17 00:00:00 2001
From: Miroslav Grepl <mgrepl@redhat.com>
Date: Mon, 23 Jun 2014 11:31:08 +0200
Subject: [PATCH 4/5] Implement --noreload option to semanage

---
 policycoreutils/semanage/semanage    | 37 +++++++++++++++++++++---------------
 policycoreutils/semanage/seobject.py |  5 +++++
 2 files changed, 27 insertions(+), 15 deletions(-)

diff --git a/policycoreutils/semanage/semanage b/policycoreutils/semanage/semanage
index 9ae3708..1b89574 100644
--- a/policycoreutils/semanage/semanage
+++ b/policycoreutils/semanage/semanage
@@ -53,16 +53,16 @@ if __name__ == '__main__':
 semanage [ -S store ] -i [ input_file | - ]
 semanage [ -S store ] -o [ output_file | - ]
 
-semanage login -{a|d|m|l|D|E} [-nrs] login_name | %groupname
-semanage user -{a|d|m|l|D|E} [-LnrRP] selinux_name
-semanage port -{a|d|m|l|D|E} [-nrt] [ -p proto ] port | port_range
-semanage interface -{a|d|m|l|D|E} [-nrt] interface_spec
-semanage module -{a|d|m} [--enable|--disable] module
-semanage node -{a|d|m|l|D|E} [-nrt] [ -p protocol ] [-M netmask] addr
-semanage fcontext -{a|d|m|l|D|E} [-efnrst] file_spec
-semanage boolean -{d|l|m} [--on|--off|-1|-0] -F boolean | boolean_file
-semanage permissive -{d|a|l} [-n] type 
-semanage dontaudit [ on | off ]
+semanage login -{a|d|m|l|D|E} [-nrsN] login_name | %groupname
+semanage user -{a|d|m|l|D|E} [-LnrRPN] selinux_name
+semanage port -{a|d|m|l|D|E} [-nrtN] [ -p proto ] port | port_range
+semanage interface -{a|d|m|l|D|E} [-nrtN] interface_spec
+semanage module -{a|d|m} [-N] [--enable|--disable] module
+semanage node -{a|d|m|l|D|E} [-nrtN] [ -p protocol ] [-M netmask] addr
+semanage fcontext -{a|d|m|l|D|E} [-efnrstN] file_spec
+semanage boolean -{d|l|m} [-N] [--on|--off|-1|-0] -F boolean | boolean_file
+semanage permissive -{d|a|l} [-nN] type 
+semanage dontaudit [-N] [ on | off ]
 
 Primary Options:
 
@@ -77,6 +77,7 @@ Primary Options:
 	-D, --deleteall  Remove all OBJECTS local customizations
 
 	-h, --help       Display this message
+	-N, --noreload   Do not reload policy after commit
 	-n, --noheading  Do not print heading when listing OBJECTS
         -S, --store      Select and alternate SELinux store to manage
 
@@ -115,7 +116,7 @@ Object-specific Options (see above):
 
 	def get_options():
 		valid_option={}
-		valid_everyone=[ '-a', '--add', '-d', '--delete', '-m', '--modify', '-l', '--list', '-h', '--help', '-n', '--noheading', '-S', '--store' ]
+		valid_everyone=[ '-a', '--add', '-d', '--delete', '-m', '--modify', '-l', '--list', '-h', '--help', '-n', '--noheading','-N','--noreload', '-S', '--store' ]
 		valid_local=[ '-E', '--extract', '-C', '--locallist', '-D', '--deleteall']
 		valid_option["login"] = []
 		valid_option["login"] += valid_everyone + valid_local + [ '-s', '--seuser', '-r', '--range']
@@ -131,11 +132,11 @@ Object-specific Options (see above):
 		valid_option["module"] += valid_everyone + [ '--enable', '--disable']
 		valid_option["fcontext"] = []
 		valid_option["fcontext"] += valid_everyone + valid_local + [ '-e', '--equal', '-f', '--ftype', '-s', '--seuser',  '-t', '--type', '-r', '--range'] 
-		valid_option["dontaudit"] = [ '-S', '--store' ]
+		valid_option["dontaudit"] = [ '-S', '--store', '-N', '--norelad' ]
 		valid_option["boolean"] = []
-		valid_option["boolean"] += ['-h', '--help','-n', '--noheading','-S', '--store','-d', '--delete', '-m', '--modify', '-l','--list'] + valid_local + [ '--on', "--off", "-1", "-0", "-F", "--file"] 
+		valid_option["boolean"] += ['-h', '--help','-n', '--noheading','-S', '--store','-N','--noreload','-d', '--delete', '-m', '--modify', '-l','--list'] + valid_local + [ '--on', "--off", "-1", "-0", "-F", "--file"] 
 		valid_option["permissive"] = []
-		valid_option["permissive"] += [ '-a', '--add', '-d', '--delete', '-l', '--list', '-h', '--help', '-n', '--noheading', '-D', '--deleteall' ]
+		valid_option["permissive"] += [ '-a', '--add', '-d', '--delete', '-l', '--list', '-h', '--help', '-n', '--noheading','-N','--noreload', '-D', '--deleteall' ]
 		return valid_option
 
         def mkargv(line):
@@ -198,6 +199,7 @@ Object-specific Options (see above):
 		seuser = ""
 		prefix = "user"
 		heading = True
+		noreload = True
 		value = None
 		add = False
 		modify = False
@@ -223,7 +225,7 @@ Object-specific Options (see above):
 
                 try:
                        gopts, cmds = getopt.getopt(args,
-                                                   '01adEe:f:i:lhmnp:s:FCDR:L:r:t:P:S:M:',
+                                                   '01adEe:f:i:lhmNnp:s:FCDR:L:r:t:P:S:M:',
                                                    ['add',
                                                     'delete',
                                                     'deleteall',
@@ -238,6 +240,7 @@ Object-specific Options (see above):
                                                     'list', 
                                                     'modify',
                                                     'noheading',
+                                                    'noreload',
                                                     'localist',
                                                     'off', 
                                                     'on', 
@@ -303,6 +306,9 @@ Object-specific Options (see above):
 			if o == "-n" or o == "--noheading":
 				heading = False
 
+			if o == "-N" or o == "--noreload":
+				noreload = False
+
 			if o == "-C" or o == "--locallist":
 				locallist = True
 
@@ -402,6 +408,7 @@ Object-specific Options (see above):
                        OBJECT.toggle(target)
                        return
                               
+		OBJECT.set_reload(noreload)
 		if add:
 			if object == "login":
 				OBJECT.add(target, seuser, serange)
diff --git a/policycoreutils/semanage/seobject.py b/policycoreutils/semanage/seobject.py
index 4cfae46..2273500 100644
--- a/policycoreutils/semanage/seobject.py
+++ b/policycoreutils/semanage/seobject.py
@@ -238,6 +238,9 @@ class semanageRecords:
 	       else:
 		       self.mylog = nulllogger()	
 
+        def set_reload(self, load):
+               self.load = load
+
         def get_handle(self, store):
 		global is_mls_enabled
 
@@ -295,6 +298,8 @@ class semanageRecords:
         def commit(self):
 		if semanageRecords.transaction:
 			return
+
+		semanage_set_reload(self.sh, self.load) 
 		rc = semanage_commit(self.sh) 
 		if rc < 0:
 			self.mylog.commit(0)
-- 
2.0.0

